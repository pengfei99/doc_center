# Install and configure bandersnatch

**It's recommended to install bandersnatch on a virtual env with a reserved uid** 

## 0. Prepare a python venv

**To Run below command, the user need to have sudoer right**

```shell
sudo apt update

# install python interpreter
sudo apt-get install python3 -y

# install pip
sudo apt-get install python3-pip

# install venv
sudo apt-get install python3-venv

# create a user bandersnatch
sudo useradd -m bandersnatch -s /bin/bash

# change current user to bandersnatch
sudo su bandersnatch

# go to the folder which you want to create the venv.
# in this tutorial we choose ~/pypi/venv, to combine with our cron job script
sudo mkdir -p ~/pypi/venv

# change owner if you need, but optional
sudo chown -R bandersnatch:root ~/pypi/venv

# goto the venv folder
cd ~/pypi/venv

# create  a virtual env called bandersnatch
# don't use sudo here
python3 -m venv bandersnatch

# test the virtual env
# activate the venv
source bandersnatch/bin/activate
```

## 2. Install the package 

```shell
# install the package
pip install bandersnatch

# test the package
bandersnatch --help
```


## 3. Config bandersnatch

When we run the command `bandersnatch mirror`, it will call a conf file which controls the behavior of the mirror.
By default, this file is located at **/etc/bandersnatch.conf**. And the default user may not have the right to create or edit this file.

### 3.1 Config file introduction

In general, we can divide it into three parts, such as:
  * The main mirror config
  * The filter plugin config
  * The log config

#### 3.1.1 The main mirror config

The official doc can be found [Here](https://bandersnatch.readthedocs.io/en/latest/mirror_configuration.html)

In this section, we define the main function of the mirror, such as:
  * **json** :  json setting is a boolean (true/false) setting that indicates that the json packaging metadata should be mirrored in addition to the packages (mandatory)
  * **workers**: The workers value is an integer from `1-10` that indicates the number of concurrent downloads. (mandatory)
  * **timeout**: The timeout value is an integer that indicates the maximum number of seconds for web requests. The default value for this setting is 10 seconds. (mandatory)
  * **hash-index**:  The hash-index is a boolean (true/false) to determine if package hashing should be used. The Recommended value is  **false** for full pip/pypi compatibility. (mandatory)
  * **stop-on-error**: The stop-on-error setting is a boolean (true/false) setting that indicates if bandersnatch should stop immediately if it encounters an error. (mandatory)
  * **directory**: it indicates  the directory path to store the mirror files
  * **master**: set the upstream of the mirror. The master url string must use **https**
  * **log-config**: The log-config setting is a string containing the filename of a python logging configuration file.

#### 3.2.2 The filtering plugin config

The filtering plugin config allows you to define a **blocklist** and **allowlist** to filter python package with:
  * project name
  * release 
  * platforms
  * size

For filtering platforms,
  * available os values are: windows, macos, freebsd, linux
  * available python versions are: py2.4 ~ py2.7, py3.1 ~ py3.10

```text
[plugins]
enabled =
    exclude_platform
    allowlist_project
    allowlist_release

[allowlist]
packages =
    pandas==2.0.2

[blocklist]
platforms = 
       macos
       freebsd
       py2.4
       py2.5
       py2.6
       py2.7
```

####  3.2.3 The log config

The log config defines where to put the output log

```text
[logging]
directory = /path/to/logs
```

The log format config file is located at **/etc/bandersnatch-log.conf**

```text
[loggers]
keys=root,file
[handlers]
keys=root,file
[formatters]
keys=common
[logger_root]
level=NOTSET
handlers=root
[logger_file]
level=INFO
handlers=file
propagate=1
qualname=bandersnatch
[formatter_common]
format=%(asctime)s %(name)-12s: %(levelname)s %(message)s
[handler_root]
class=StreamHandler
level=DEBUG
formatter=common
args=(sys.stdout,)
[handler_file]
class=handlers.TimedRotatingFileHandler
level=DEBUG
formatter=common
delay=False
args=('/repo/bandersnatch/banderlogfile.log', 'D', 1, 0)
```

### 3.2  A example of a simple conf

In the below config example **/etc/bandersnatch.conf**, we will mirror `pandas,folium` package from pypi.org for the windows and linux OS and for python 3.8, 3.9, 3.10

```text

[mirror]
json = true
directory = /home/bandersnatch/pypi/data
master = https://pypi.org
workers = 4
timeout = 40
stop-on-error= false
hash-index = false

[plugins]
enabled =
  exclude_platform
  allowlist_project
  allowlist_release

[allowlist]
packages =
    pip
    pandas
    folium

[blocklist]
platforms =
     macos
     freebsd
     py2.4
     py2.5
     py2.6
     py2.7


[logging]
directory = /home/bandersnatch/pypi/log
```

### 3.3 Standard config for the cron job
To avoid access rights problem, we recommend you use the below config file path to host the config

```shell
mkdir -p ~/pypi/conf
vim ~/pypi/conf/bandersnatch.conf
```

And put the above config file content in it.

### 3.4 Test your installation

```shell
# activate the venv if it's not activated
source ~/pypi/venv/bandersnatch/bin/activate

# start the mirror process
bandersnatch -c ~/pypi/conf/bandersnatch.conf mirror
```

After the above command finished, you should see the following file and directory
- generation (file)
- status (file)
- web (directory which contains all the packages and index)

## 4. Serve the package 

Once the `bandersnatch mirror` command succeeds, you’re now ready to serve your mirror. Any webserver can do this, as long as it can serve the simple HTML and packages directory that the HTML links to.

In a production environment, we recommand you to use **nginx** as the web server.

In a dev environment, you can use `python simple http server`

### 4.1 Use nginx to serve the package

```shell
# install
sudo apt install nginx

# Start Nginx: Once the installation is complete, Nginx should start automatically. If not, you can start it manually by executing the following command
sudo systemctl start nginx
```

Create a nginx server conf for to serve the package. We name the conf file as **pypi-repo.conf**. Put the below file in `/etc/nginx/sites-available`

```text
server {
    listen 80;
    server_name pypi.casd.local;

    # redirect http request to https
    return 301 https://$host$request_uri;

}


server {
    listen 443 ssl;
    ssl_certificate /etc/ssl/certs/casd_k8s_wildcard.pem;
    ssl_certificate_key /etc/ssl/private/casd_k8s_wildcard_key.pem;
    server_name pypi.casd.local;

    # root /package-repo/pypi/data/web;

    location / {
        root /package-repo/pypi/data/web;
        autoindex on;
        charset utf-8;
        autoindex_exact_size off;
        try_files $uri $uri/ =404;
    }
}

```


Now let's enable the conf

```shell
# create a soft link 
sudo ln -s /etc/nginx/sites-available/pypi-repo.conf /etc/nginx/sites-enabled/pypi-repo.conf

# check the validity
sudo nginx -t

# restart the server
sudo systemctl restart nginx

```

Now you should be able to open  `http://pypi.casd.local/simple/pandas/` to check all available pandas sources

### 4.2 Use python simple http server

## 5. Configure pip to use the private repo

By default, pip only accept URL with **https**,  if your URL is in HTTP, you will have many problems. So we highly recommend you to add a certificate

The configuration of pip is different based on the pip version

### 5.1 Temporary Config

```shell
pip install <package-name> --index-url <repo-url> --trusted-host <repo-domain>

# for example, if the repo domain is pypi.casd.local and the repo URL is http://pypi.casd.local/simple
pip install pandas --index-url http://pypi.casd.local/simple --trusted-host pypi.casd.local

```

### 5.2 Permenent Config
You can use the `pip config` command to configure permenently the pip behaviour. The official doc of the [pip config](https://pip.pypa.io/en/stable/cli/pip_config/).

#### 5.2.1 For pip >= 10.0 

```shell
# set the index server url
pip config set global.index-url http://pypi.casd.local/simple 

# If the server is in HTTP, you need to add the below line to force pip to accept the domain
pip config set global.trusted-host pypi.casd.local

# check the current config file content
pip config list
```

> This command will create a file `pip.conf` in the current user home (e.g. `$HOME/.config/pip/pip.conf`).

#### 5.2.2 For older version

```shell
pip install --upgrade pip --index-url http://pypi.casd.local/simple --trusted-host pypi.casd.local
```

#### 5.2.3 Edit the config file directly

You can find the official doc [here](https://pip.pypa.io/en/stable/topics/configuration/#configuration-files)

pip has 3 “levels” of configuration files:

- **global**: system-wide configuration file, shared across users.

- **user**: per-user configuration file.

- **site**: per-environment configuration file; i.e. per-virtualenv

```shell
# open the pip.conf file, find the global section 
[global]
index-url = http://pypi.casd.local/simple

```

The path of the per-user configuration file can be different, below are some path example of the global configuration file:

  * Linux: `/etc/pip.conf`
  * macOS: `/Library/Application Support/pip/pip.conf`
  * Windows: On Windows 7 and later: `C:\ProgramData\pip\pip.ini` (hidden but writeable)


## 6.Things that I don't like in bandersnatch

### 6.1 mirrored-files

Each time when you run **bandersnatch mirror** command, it will create a file called **mirrored-files** in the current directory.

If you changed directory and run **bandersnatch mirror** command again, it will not be able to locate previous **mirrored-files**. And it will not start the 
mirror process. As a result, no change will make.

You can use command **bandersnatch mirror --force-check** to overcome this. But sometimes, it does not work, you need to remove the wrongly generated **mirrored-files** file, then rerun **bandersnatch mirror --force-check**

### 6.2 No auto dependencies checks

There is no automatic dependencies checks. For example in the allow_list, if I put **pandas**, bandersnatch will only mirror the package source or wheel file of pandas. All the pandas dependencies (e.g. python-dateutil, numpy, six) will not be mirrored. When you installed, pip will show the error that it can find numpy, etc.

So we need to determine the dependencies manually and add all dependencies to the allow_list.  I just develop a litte python client to generate the dependencies automatically.

You can find the repo [here](https://github.com/CASD-EU/PyPiDepDetective.git)

