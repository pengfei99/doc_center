# The bandersnatch cron job 

There are three step in the cron job scripts:
1. Activate the virtual env that runs the `bandersnatch` and the `dependencies checker`
2. Run the dependencies checker to get the complete list of the packages with dependencies
3. Start the bandersnatch mirror process
4. zip the downloaded packages and index build.

## 1 The cron job requirement



The cron job requires the complete installation of the bandersnatch and the conf file is provided. Below shows the requirements
which the installation needs to respect. 

  * has a valid venv that contains all the dependencies
  * has the required folders
  * has the dependencies checker script

### 1.1 The required folders

If you followed the previous tutorial to install the bandersnatch, your directory should be organized as below:

```text
pypi
    ├── bin: contains the dependencies checker script
    ├── conf: contains the bandersnatch conf
    ├── data: contains the mirrored packages and index 
    ├── export: the zipped release tagged with release date
    ├── log: corn job log
    └── venv: contains the venv that allows the scripts to run

```

### 1.2 The required system dependencies

The corn job requires **zip** to build the release, so you need to install it

```shell
sudo apt install zip -y

```
### 1.3 The dependencies checker ====

As I explained before, the Bandersnatch does not check the required dependencies for the mirrored package, so we write a script that can calculate the dependencies and update the Bandersnatch config file automatically. 

The repo git is here: https://github.com/CASD-EU/PyPiDepDetective

This script requires below package to run, so you need to install it in the bandersnatch venv

```shell
# change uid to bandersnatch
sudo su bandersnatch

# activate the venv if it's not activated
source ~/pypi/venv/bandersnatch/bin/activate

# install the packages
pip install requests johnnydep

# copy the above script in to below file
vim ~/pypi/bin/detective.py

# Test the script
python3 ~/pypi/bin/detective.py -h

# If you see the help page of the script, it means the installation is successful

```
## 2. The corn job script

Now you have everything you need to run the cron job script. 

You can find the script [here](../bash_commands/pypi_build_release.sh)

## 3. Test the corn job script 

### 3.1 To test the script without crontab


```shell
sudo su bandersnatch

bash /path/to/pypi_build_release.sh

```

### 3.2 To test the script with crontab

There are two possible way to set up the cron job:
  - set up cron job as root
  - set up cron job as bandersnatch

#### 3.2.1 As root

If you run the cron job in the root crontab, you need to add the uid bandersnatch to specify that the script need to run with uid bandersnatch

```text
# the script will run at 6:00 am every Saturday
0 6 * * 6 bandersnatch /path/to/pypi_build_release.sh
```

#### 3.2.2 As bandersnatch

If you run the cron job in the bandersnatch crontab, you don't need to add the uid bandersnatch

```text
# the script will run at 6:00 am every Saturday
0 6 * * 6 /path/to/pypi_build_release.sh

```





