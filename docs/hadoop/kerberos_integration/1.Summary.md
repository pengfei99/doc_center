# Kerberos integration in cluster hadoop spark

The objective of kerberos integration is to enforce user authentication and access control.


## General steps

In this tutorial, we use AD/krb as the authentication server. 

1. Design the cluster architecture, for each server `define a hostname`
2. Configure AD for service account(e.g. hdfs, yarn, ssh, http) which runs inside linux server
3. Configure DNS for the linux server
4. Define different group for common-user, and admin user for different server access(namenode, datanode open to admin only)
5. Setup hadoop master 
6. Setup hadoop worker 
7. Setup hadoop client


## 1. Design the cluster architecture
In this tutorial, the cluster has 4 servers. 
1. hadoop-client: allow user to submit spark jobs, view job status, view data in hdfs.
2. hadoop-master: hdfs namenode, spark master node.
3. hadoop-worker1: hdfs datanode, spark worker node.
4. hadoop-worker2: hdfs datanode, spark worker node.

## 2. Configure AD for service account

AD provides different types of account, we choose to use `gMSA`. So the first step is to create gMSA account for the 3 servers.

For each host in the hadoop cluster(master and worker), we need a `gMSA` account. And the account must have the below attributes:
```shell
# servicePrincipalName
├── hdfs/nom_de_host.exemple.com@EXEMPLE.COM      # Service YARN & hdfs
├── host/nom_de_host.exemple.com@EXEMPLE.COM      # Service ssh 
└── HTTP/nom_de_host.exemple.com@EXEMPLE.COM      # Interface Web

# userPrincipalName
hdfs/nom_de_host.exemple.com@EXEMPLE.COM
```
For example, if we have 3 hosts(1 master, 2 workers) in the cluster, we need to have `three gMSA` accounts.

As we need to synchronize the `keytab file` with `gMSAd`, we need a static user account which allows us to do the refresh

### 2.1 Create a gMSA account

```powershell
# create a gMSA account
New-ADServiceAccount -Name "gMSA-hclient" -Description "hadoop client linux" -DNSHostName "gMSA-hclient.casdds.casd" -ManagedPasswordIntervalInDays 1 -PrincipalsAllowedToRetrieveManagedPassword "Linux" ` -Enabled $True

# add spn to a gMSA account
setspn -A host/hclient.casd.fr@CASD.FR hclient
setspn -A HTTP/hclient.casd.fr@CASD.FR hclient
setspn -A HDFS/hclient.casd.fr@CASD.FR hclient
```

### 2.2 Setup dns

In the dns manager:
- create a host with hostname:`gMSA-hclient.casdds.casd` and it's associate IP.
- create a Pointer(PTR) with hostname:`gMSA-hclient.casdds.casd` and it's associate IP.


### 2.3 Set up the hostname in the linux server

The hostname in the linux server must match the AD and dns setup hostname

```shell
# change hostname
sudo hostnamectl set-hostname gMSA-hclient.casdds.casd

# change /etc/hosts with the below lines
sudo vim /etc/hosts 
127.0.0.1       localhost
10.50.5.224     gMSA-hclient.casdds.casd    gMSA-hclient

# edit resolv to setup AD as dns
sudo vim /etc/resolv.conf 

# add the below lines
search casdds.casd
nameserver <ad-ip>
```

## 2.4 Create a daemon to sync gMSA account credential(gMSAd)

You can find the project github page [here](https://github.com/cea-sec/gmsad/tree/main)


### 2.4.1 Create local account to run gMSAd

It's recommended to run the gMSA daemon with a specific service account

```shell
# create group
addgroup --system gmsa

# create service account
adduser --system --no-create-home --shell=/usr/sbin/nologin --ingroup=gmsa gmsa
```



### 2.4.2 Install the gMSA binary

```shell
sudo apt-get install -y python3 python3-pip python3-venv libkrb5-dev krb5-user sssd-ad sssd-tools

# create a virtual env
python3 -m venv gmsad-venv

# activate the venv
source gmsad-venv/bin/activate

# install the gmsad via .wheel files inside the venv
pip install --no-index --break-system-packages -f ./ gmsad-0.2.0-py3-none-any.whl

# or via repo pypi
pip install --break-system-packages gmsad

# check the gmsad version
which gmsad

pip show gmsad

```
> we recommend you to install the gmsad inside a venv
> 
### 2.4.3 Configure gMSAd

The main configuration file of gMSAd is located at `/etc/gmsad.conf`
```ini
[global]
realm = CASDDS.CASD
domain = casdds.casd
gMSA_domain = CASDDS.CASD

# Configuration LDAP
ldaps = ldaps://10.50.5.64:636

# Authentification
principal = Linux@CASDDS.CASD
keytab = /etc/Linux.keytab

# Configuration gMSA
gmsa_name = gMSA-hclient
gmsa_dn = CN=gMSA-hclient,CN=Managed Service Accounts,DC=casdds,DC=casd
gMSA_sAMAccountName = gMSA-hclient
gMSA_keytab = /etc/krb5.keytab

gMSA_servicePrincipalNames = host/gMSA-hclient.CASDDS.CASD,HTTP/NOM_HOST.EXEMPLE.COM,hdfs/NOM_HOST.EXEMPLE.COM

# Où écrire le keytab
target_keytab = /etc/krb5.keytab
post_renew_cmd = systemctl restart sssd.service

# Logging
log_level = INFO
```

> the ownership of  `/etc/Linux.keytab` should be gmsa:root
> the permission of `/etc/Linux.keytab` should be 640
> the ownership of  `/etc/krb5.keytab` should be root:gmsa
> the permission of `/etc/krb5.keytab` should be 640
> 
> We also need to check if the account `Linux@CASDDS.CASD` exists in AD. If existed, generate the `Linux.keytab` file.
> Don't forget to create the init `krb5.keytab` file sudo touch `/etc/krb5.keytab`.

```shell
$SamAccountName = "Linux"
$Realm          = "CASDDS.CASD"
$KeytabPath     = "C:\temp\linux.keytab"
$Crypto         = "AES256-SHA1"

$Principal = "$SamAccountName@$Realm"

# ==========================
# Generate keytab
# ==========================
ktpass `
  -princ $Principal `
  -mapuser $SamAccountName `
  -ptype KRB5_NT_PRINCIPAL `
  -crypto $Crypto `
  -pass * `
  -out $KeytabPath
```

> The above command will prompt you to enter a password, this password will replace the old password of user account AD. 
> So **all the old keytab file is no longer valid** if the password is different.

As the `gmsa account` must have the right to restart sssd, we need to add a line in sudoer

```shell
gmsa ALL=(root) NOPASSWD:systemctl restart sssd.service
```

### 2.4.4 Create a systemd service for gmsad

```ini
[Unit]
Description=gMSA daemon (gmsad)
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=gmsa
Group=gmsa

Environment="VIRTUAL_ENV=/opt/gmsad_venv"
Environment="PATH=/opt/gmsad_venv/bin:/usr/bin:/bin"

# Clean old keytab safely before start
# to be discussed
# ExecStartPre=/usr/bin/rm -f /etc/krb5.keytab

ExecStart=/opt/gmsad_venv/bin/gmsad --config /etc/gmsad.conf

Restart=always
RestartSec=10
TimeoutStartSec=60

# Hardening (safe defaults)
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=full
ProtectHome=true
ReadWritePaths=/etc/krb5.keytab

[Install]
WantedBy=multi-user.target

```
## Setup hadoop master

Setup krb client and sssd, pam, ssh for user access of the linux server


## Setup hadoop worker

## Setup hadoop client
 