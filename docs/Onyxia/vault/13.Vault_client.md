# Vault client

Vault server proivdes a web UI and a CLI. In this tutorial, we will show how to 
- install vault cli
- create a secret
- update a secret with version
- get secret with version
- delete secret

## Install vault client

The official installation doc can be found [here](https://developer.hashicorp.com/vault/downloads)


```bash
# add hashicorp repo to the apt repo list
wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list

# install vault via apt
sudo apt update && sudo apt install vault
```
## Use the default vault client pods

If you deploy vault via the hashicorp helm chart, you should find a pod called `vault-0` in the vault namespace. This pod contains a vault client and `pre-configured` token to connect to the vault server.

```shell
# get a shell of the vault-0 pod
kubectl exec -it vault-0 -n vault -- /bin/sh

# try 
vault status
```


## Use vault client to connect to the server

```bash
# to set up the client connextion
export VAULT_ADDR='https://vault.casd.local'
export VAULT_TOKEN="hvs.6202Qj6vOLuCYpDu79MQGf1e"

# check your connextion
vault status

# you should see below output
Key             Value
---             -----
Seal Type       shamir
Initialized     true
Sealed          false
Total Shares    3
Threshold       2
Version         1.12.0
Build Date      2022-10-10T18:14:33Z
Storage Type    file
Cluster Name    vault-cluster-b5283424
Cluster ID      9ef14394-39ec-bd05-e26d-40f29737c5fb
HA Enabled      false

# In this case, the vault is already unsealed, if it's sealed, you need to unsealed with the shared secret. Below are some examples (in our case 2 shared secret is enough)
vault operator unseal p9ySCyRaHXUhQQAw3PgkQhSvoe+mexRlZGILDi2ieLji
vault operator unseal a8IQbNnbUWLx5mK//nkG0NIO4XtYbeqOFnS7R1STJhQg
vault operator unseal 4Q+qgYNYTRqER5NdrzFwyYSmI6ZcQ4qYcvat0YKCGqJB

```

If you need to connect to a new `vault` server. You need to reset the env var value of `VAULT_ADDR` and `VAULT_TOKEN`.

```bash
# remove the old value
unset VAULT_ADDR
unset VAULT_TOKEN

# set new values
export VAULT_ADDR='https://vault.casd.local'
export VAULT_TOKEN="hvs.6202Qj6vOLuCYpDu79MQGf1e"
```

## Use client to creaet kv secret

Vault provide many different types of secret. Below figure shows them
![vault_secret_list.PNG](../images/vault_secret_list.PNG). In this tutorial, we only show example on the `kv secret engine`

The below command can be realized via the vault web ui
```shell
# activate kv secret engine
vault secrets enable kv

# create your first secret (in kv engine)
# second kv/pengfei-cli is the name of the secret, k2=v2 is the content of the secret
vault kv put kv/pengfei-cli k2=v2

# get the secret content
vault kv get kv/pengfei-cli

# you should see below output
=== Secret Path ===
kv/data/pengfei-cli

======= Metadata =======
Key                Value
---                -----
created_time       2022-10-31T08:32:34.841417078Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

=== Data ===
Key    Value
---    -----
k2     v2

```

In the `vault web ui`, you should see below figure

![vault_secret_kv_example.PNG](../images/vault_secret_kv_example.PNG)

## secret versioning

One of the important vault feature is the `secret versioning`. We will add version support on the above secret `pengfei-cli`.

```shell
# active versioning
vault kv enable-versioning kv/

# try to update the value of the secret
vault kv put kv/pengfei-cli k2=toto

# by default, vault will return the latest version
 vault kv get kv/pengfei-cli

# get a specific version
vault kv get -version=1 kv/pengfei-cli
```

## secret deletion

When a secret is deleted, all the key/value pair in it will be deleted.

```shell
# delete a secret
vault kv delete kv/pengfei-cli

# delete a specific version
vault kv delete -versions=1 kv/pengfei-cli

# cancel delete
vault kv undelete -versions=1 kv/pengfei-cli

# delete permently, no possible cancel
vault kv destroy -versions=1 kv/pengfei-cli
```

