# 01. Provisioning infrastructure

To determine how many servers you need to set up an appropriate infrastructure, you can follow the official [doc](https://github.com/kubernetes-sigs/kubespray#requirements)

In this tutorial, I will have 3 master node, 3 worker node.

## 1.1 Create the vm

Here I suppose you use the on-premise cloud infrastructure to creat the VMs. For testing you can use any solution (e.g virtual box). You can find some docs on vm creation and network setup for virtual box [here](sys_admin).

## 1.2 Configure the vm

To allow kubespray to install packages, you need to set up the vm with some specific configuration such as

- selinux
- firewall
- ssh connection

### 1.2.1 Disable selinux (Centos ) 

### 1.2.2 firewall (debian/ubuntu)

The default firewall in ubuntu is called `ufw`, you can use below command to start/stop it or check its status.

```shell
# enable/disable
sudo ufw enable/disable

# get the status of the firewall
sudo ufw status

# for more details, you can add `verbose`
sudo ufw status verbose
```

### 1.2.3 Configure ssh tunnel

Ansible needs ssh tunnel to install and configure everything. So having a ssh is essential

#### install openssh-server

```shell
# update package repo cache
sudo apt update

# intall the server
sudo apt install openssh-server

# check the ssh server status
sudo systemctl status ssh

# start/stop the ssh server
sudo systemctl start/stop ssh

# adding and removing the ssh server in the system startup list
sudo systemctl enable/disable ssh

```

#### generate ssh key

Below command will allow you to generate a new Asymmetric keypair by using `ecdsa` algo, the key size will be 521 bits with a comment (mail of the owner).

```shell
ssh-keygen -t ecdsa -b 521 -C "your_email@domain.com"

# you should see below output
Your identification has been saved in /home/pliu/.ssh/id_ecdsa

Your public key has been saved in /home/pliu/.ssh/id_ecdsa.pub

The key fingerprint is:

SHA256:0932dP01k2JEPAHWcDjWtfLcnanLW+KtOPo+7R6tG+8 pliu@debian01

The key's randomart image is:

+---[ECDSA 521]---+

|           +B+o. |

|          .+o=  .|

|          . .o.. |

|         . ...+ B|

|        S . .ooOB|

|         .  ..+o*|

|            .= oo|

|           o+.X  |

|         .++=@=E |

+----[SHA256]-----+


```

**The private key should be stored in the server which runs kubepray. The public key should be stored in the server (e.g. master node, worker node) of the k8s cluster.**

#### Copy the generate public key to k8s cluster servers

The best way is to use `ssh-copy-id` tool. The syntax is:

```shell
ssh-copy-id username@target_url/ip

# for example
ssh-copy-id pliu@10.0.2.4

# now try to ssh to the 
ssh pliu@10.0.2.4
```

If you don't have `ssh-copy-id` tool, you can copy the **public key** Manually.

In the target server, create a file (~/.ssh/authorized_keys) inside the user namespace which you want to use to ssh.

Get the content of public key

```shell
cat ~/.ssh/id_ecdsa.pub 

# You should see something like this
ecdsa-sha2-nistp521 AAAAE2VjZHNhLXNoYTItbmlzdHA1MjEAAAAIbmlzdHA1MjEAAACFBADCrz1ud4x0++fZ18KTnYBoqlwe3Qj9Y0TLF87oZj1xyOCnBimj0mkutMUy4+Mmu3yVDfPs23wH31vqx+jV31H5OwCydxd/KBz8fu+fOStt8HIyFix8lq45DhzDnBbaf/etOsWHTz4r13WYazADLVDJAOKTG7SGy9JBFFSyBEDx6ZjUbA== pliu@debian01

```

Now copy the public key to the file (~/.ssh/authorized_keys). Note if you are using root account to do the copy, don't forget to change the owner and group of the file. Otherwise, the user can't open it, because it belongs to root.

```shell
chown -R pliu:pliu /home/pliu/.ssh
```

#### Disable password auth (Optional)

In the `/etc/ssh` folder, you can find the **sshd_config** file (the main config of ssh server). Add below line to disable password ssh auth

```text
PasswordAuthentication no
```

#### Restart ssh service

To make the change effective, you need to restart the ssh server

```shell
sudo systemctl restart ssh
```

#### Disable swap

**Kubelet can't manage swap. So you need to disable swap on all nodes.**

```bash
# Check the current status of the file system
lsblk -o +PARTTYPE

# disable swap if you find any
$ sudo swapoff -a
$ sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
```

