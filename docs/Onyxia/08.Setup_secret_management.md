# 8. Secret management in Onyxia

Onyxia requires a secret management service to store user's secret inside the cluster. For now `HashiCorp Vault` is the solution that Onyxia uses.

## 8.1 Vault introduction

You can find the principal Vault use cases in this [page](https://developer.hashicorp.com/vault/docs/use-cases)

### 8.1.1 Vault main functionalities

If you never used `Vault` before, you can follow this [tutorial](https://learn.hashicorp.com/tutorials/vault/getting-started-first-secret?in=vault/getting-started) to play with it.


### 8.1.2 Vault internal architecture



## 8.2 Vault on k8s

The vault service on k8s has more feature than a vault on traditional server. For example, **Vault agent** containers can inject secret into `Pods`. 

This [doc](https://devopscube.com/vault-in-kubernetes/) is very good in explaining vault on k8s 

You can find many vault on k8s tutorial on this [page](https://developer.hashicorp.com/vault/tutorials/kubernetes)


### 8.2.1 Deploy vault via helm chart

In this doc, we will use the [hashicorp vault-helm](https://github.com/hashicorp/vault-helm) to deploy a vault on k8s. The default configuration file can be found [here](https://github.com/hashicorp/vault-helm/blob/main/values.yaml)

This [tutorial](https://developer.hashicorp.com/vault/tutorials/kubernetes/kubernetes-raft-deployment-guide) is a good start, if you are new to vault



```shell
# creat name space
kubectl create namespace vault

# add hashicorp repo
helm repo add hashicorp https://helm.releases.hashicorp.com

# check available chart version
helm search repo hashicorp/vault --versions

# use a dry-run to find out default config
helm install vault hashicorp/vault --namespace vault --dry-run

helm install vault hashicorp/vault --namespace vault --values vault-casd.yaml
```

### 8.2.2 TLS certificates

If a `private Certificate Authority (CA)` is used, you can pass the path to the CA Cert using the environment variable **VAULT_CACERT** through the use of the **server.extraEnvironmentVars** attribute, such as:

```yaml
server:
  extraEnvironmentVars:
    VAULT_CACERT: /vault/userconfig/tls-ca/ca.crt

```

To create this file and path inside the Vault Pods, you can create a Kubernetes Secret from the contents of the TLS Certificate file and this can be mounted using the **server.extraVolumes** attribute.

> The Kubernetes Secret needs to be created before the installation of the Vault Helm chart

Below is an example on how to create a such secret

```bash
kubectl -n vault create secret tls vault-ca-crt --cert ./ca.pem --key ./ca-key.pem
```
 
You can mount 


## 8.3 Vault init

After all the pods are created, you should be able to access the vault ui via `https://vault.casd.local`. Then you need to initial the vault with a root key and a number share keys.

Vault uses [Sharmir's secret sharing algo](https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing) to share the secret. You will need a majority of the share keys to `unseal` the vault.

Below is an example, I choose 3 share key and 2 as the majority.

```text
- root key: hvs.jf0pP8bHd16frMJVImQ65yUF
- share key1: UYGy5Ke1G2Grew5uPdYzD/rJh7ncB29i6p4XISkcUxNO
- share key2: Mgvif9S1+7ZvBASMHusgAUabat8l5VlmactMNJd9qogQ
- share key3: +7qtRVm1brRjuqOc3Nsut69RA8gZ9QF3NVprrvsxlrLp
```


## 8.4 Integrate Vault into Onyxia

To integrate `vault` into Onyxia, we need to 
- configure keycloak client for `vault`
- configure `vault` (e.g. enable JWT,  setup user acl policies)
- update `onyxia` helm deployment config values, and upgrade the helm chart

### 8.4.1 Vault with keycloak integration

#### 8.4.1.1 Create a new auth client for vault

1. To create a new auth **client**, you need to login to keycloak admin console
2. Choose a realm (its better to put it in the same realm of onyxia auth client)
3. Click on `Clients` (on the left side panel), then click on `create` (right side panel, on top of client list)
4. In `Client ID`, you put the name of this auth client. In our case we use `vault`. In `Root URL`, you put the url of the service which will use this auth client. In our case, it's `https://vault.casd.local`. Then click on `save`.

5. Now, you should see a larger form to fill. You need to pay attentions to 
  - Root URL: `https://vault.casd.local`
  - Valid Redirect URIs: `https://vault.casd.local/*`
  - Web-origins:  `https://vault.casd.local`. Keep the `Access Type` as `public` 
6. In `advanced settings`, you can change the `access token lifespan`. 

Below figure is an example
![vault_keycloak_auth_client.PNG](../images/vault_keycloak_auth_client.PNG)

#### 8.4.1.2 Create a mapper in vault client

You need to create a **mapper** inside the `vault`'s auth client which you just created

1. To create a new `mapper`, click on the vault auth client. On the right panel, click on `Mappers` (on top). Then click on `create`, it will popup a form which you need to fill.
2. Name: `vault`;   Mapper Type: `Claims parameter Token`; 
3. `Add to ID Token` need to be `Enabled`     
4. Click on `save`. 

Below figure is an example
![vault_keycloak_vault_client_mapper.PNG](../images/vault_keycloak_vault_client_mapper.PNG)

#### 8.4.1.3 Create a mapper (audience) in onyxia client

To create an **audience** :
1. click on the `onyxia auth client`, in our case the name is `onyxia-client`. On the right panel, click on `Mappers` (on top). Then click on `create`, it will popup a form which you need to fill.
2. Name: `vault`;   Mapper Type: `Audience`; Included Client Audience: `vault`
3. `Add to ID Token` need to be `Enabled`     
4. Click on `save`.

> Note if you named your `vault` auth client other than `vault`, you should change the `Included Client Audience` value accordingly.

Below figure is an example

![vault_keycloak_onyxia_client_mapper.PNG](../images/vault_keycloak_onyxia_client_mapper.PNG)

### 8.4.2 Configure Vault

To complete below command, you will need the `vault CLI`. You can follow this [doc](./sys_admin/13.Vault_client.md) to install a vault CLI.

#### 8.4.2.1 Enable JWT support

First, we need to create a `JWT endpoint` in Vault, and writing information about `Keycloak` to the configuration. The **default_role="onyxia-user"** will be used by `Onyxia` to connect to Vault.

```shell
# enable jwt auth module
vault auth enable jwt

# configure the jwt provider, here we use a keycloak instance
# the @ca.pem will read a local .pem file and pass the content of the file
# as the argument to oidc_discovery_ca_pem
vault write auth/jwt/config \
    oidc_discovery_url="https://auth.casd.local/auth/realms/casd-onyxia" \
    oidc_discovery_ca_pem=@ca.pem
    default_role="onyxia-user"

# if every works well, you should see below line
Success! Data written to: auth/jwt/config
```

This will creat a new auth type, you can get all possible auth type via below command

```shell
vault auth list

# You should see below output, note the Accessor is important to id an auth type
Path      Type     Accessor               Description                Version
----      ----     --------               -----------                -------
jwt/      jwt      auth_jwt_7572e714      n/a                        n/a
token/    token    auth_token_c248f5e8    token based credentials    n/a

```


#### 8.4.2.2 Set the ACL policy

1. Create a acl policy file called `onyxia-kv-policy.hcl`, and put the following content

```text
path "onyxia-kv/{{identity.entity.aliases.auth_jwt_7572e714.name}}/*" {
  capabilities = ["create","update","read","delete","list"]
}

path "onyxia-kv/data/{{identity.entity.aliases.auth_jwt_7572e714.name}}/*" {
  capabilities = ["create","update","read"]
}

path "onyxia-kv/metadata/{{identity.entity.aliases.auth_jwt_7572e714.name}}/*" {
  capabilities = ["delete", "list", "read"]
}
```

2. Upload the policy to vault server

```shell
vault policy write onyxia-kv onyxia-kv-policy.hcl
```

3. Enable the `onyxia-kv` secret engine

```shell
vault secrets enable -path=onyxia-kv kv-v2
```

4. Add new role `onyxia-user` to jwt auth type

To creat a new role, we need to specify 
- role_type: 
- bound_audiences: keycloak auth client name for vault server
- user_claim: 
- policies: The policy that we created  

Below is an example

```shell
vault write auth/jwt/role/onyxia-user \
    role_type="jwt" \
    bound_audiences="vault" \
    user_claim="preferred_username" \
    policies="onyxia-kv"

# if everything works well, you should see below output
Success! Data written to: auth/jwt/role/onyxia-user
```

### Actives cors dans vault

The official doc can be found [here](https://developer.hashicorp.com/vault/api-docs/system/config-cors)

```shell
# get current core settings
curl --header "X-Vault-Token: hvs.jf0pP8bHd16frMJVImQ65yUF" https://vault.casd.local/v1/sys/config/cors
```

To update the core setting, we need to use `POST` on `/sys/config/cors`

Below is an example payload

```json
{
    "allowed_origins": "https://datalab.casd.local",
    "allowed_headers": "X-Custom-Header"
}

```
>  don't forget to use the complete url (https://). The `allowed_headers` is useful when you have custom headers which you want vault to accept. The standard headers are added by default.  

Sample request

```shell
curl \
    --header "X-Vault-Token: hvs.jf0pP8bHd16frMJVImQ65yUF" \
    --request POST \
    --data @cors.json \
    https://vault.casd.local/v1/sys/config/cors
```

To delete core settings

```shell
curl \
    --header "X-Vault-Token: ..." \
    --request DELETE \
    https://vault.casd.local/v1/sys/config/cors

```

### 8.4.3 Update the onyxia helm chart

The new onyxia helm config file can be found in [vault.yaml](../resources/onyxia/vault.yaml).


You need to add below lines in `api.regions.vault`
```yaml
"vault": { 
                "URL": "https://vault.casd.local",
                "kvEngine": "onyxia-kv",
                "role": "onyxia-user"
        },
```


```shell
helm upgrade onyxia inseefrlab/onyxia -f vault.yaml
```