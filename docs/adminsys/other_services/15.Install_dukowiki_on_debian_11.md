# Install dukowiki on debian 11

## Prerequise

Dukowiki needs a web server and a PHP env to run. So we need to install **Nginx** and **PHP** first.

> Dukowiki does not support PHP 8+ yet, so we need to install PHP7.x

For debian 11, the default php version is 7.4, which is perfect for dukowiki. So the easiest way is to use the apt-get to install these packages

```shell
apt-get install nginx php-fpm php-curl php-gd php-opcache php-json php-mbstring php-intl php-imagick php-xml -y
```

The `php-fpm(FastCGI Process Manager)` is very important, which is a `SAPI` interface. It allows the communication between the `web server(nginx)` and `PHP run time` by using the `FastCGI` protocol.



### Remove apache2 

The default web server in debian 11 is apache2, so we need to delete it.

```shell
systemctl stop apache2
systemctl disable apache2
apt-get remove apache2 --purge
```

### Check the installed nginx and php-fpm

```shell
systemctl start nginx
systemctl enable nginx

systemctl start php7.4-fpm
systemctl enable php7.4-fpm
```


## Download the source of Dokuwiki

```shell
# go to the default folder of the web static content
cd /var/www/html
 
# download the source
wget https://download.dokuwiki.org/src/dokuwiki/dokuwiki-stable.tgz

# extract the source
tar -xvzf dokuwiki-stable.tgz

# rename the file
mv dokuwiki-* dokuwiki

# change owner and acl of the dokuwiki
chown -R www-data:www-data /var/www/html/dokuwiki
chmod -R 755 /var/www/html/dokuwiki
```

## configure Nginx

Create an Nginx `virtual host` configuration file for DokuWiki

```shell
vim /etc/nginx/site-available/dokuwiki.conf
```

```text 
server {
    listen 80;
    server_name wiki.casd.local;

    # redirect http request to https
    return 301 https://$host$request_uri;

}

server {
    listen 443 ssl;
    root /var/www/html/dokuwiki;
    index index.php index.html;

    ssl_certificate /etc/ssl/certs/casd_k8s_wildcard.pem;
    ssl_certificate_key /etc/ssl/private/casd_k8s_wildcard_key.pem;

    location / {
        try_files $uri $uri/ @dokuwiki;
    }

    location @dokuwiki {
        rewrite ^/_media/(.*) /lib/exe/fetch.php?media=$1 last;
        rewrite ^/_detail/(.*) /lib/exe/detail.php?media=$1 last;
        rewrite ^/_export/([^/]+)/(.*) /doku.php?do=export_$1&id=$2 last;
        rewrite ^/(.*) /doku.php?id=$1&$args last;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

}

```

Save and close the file, then verify Nginx config file validity. If its valide then activate the Nginx virtual host. You can use the following command:

```shell
# check conf syntax
sudo nginx -t

# activate the virtual host
sudo ln -s /etc/nginx/sites-available/dokuwiki.conf /etc/nginx/sites-enabled/
```
### Some trouble shoot

If you experience this issue:

```text
nginx: [emerg] could not build server_names_hash
```

You should edit the `/etc/nginx.conf` file, change server_names_hash_bucket_size: 32  to 64:

```text 
server_names_hash_bucket_size 64;
```

Next, restart the Nginx service to apply the changes:

```shell
systemctl restart nginx
```

## Init dokuwiki

open your web browser and access the DokuWiki installation using the URL **http://doku.example.com/install.php**. You should see a fomular which allows you to set `wiki name, admin user login, passwd, etc.`

Provide your Wiki name, admin username, password, and email and click on the **Save** button.

Click on `your new DokuWiki` link. You will be redirected to the DokuWiki welcome screen

## Migrate from older version 

The advantage of dokuwiki is that it does not need database, so the migration is quite easy. 

All the content is stored under `/var/www/html/dokuwiki/data`. To migrate just copy your old wiki's **data folder** and replace the **data folder** of your newly installed wiki.

New version of the duko wiki also store logs in **log** folder. If the data folder of your old wiki does not have `log folder`, you need to create it manually. And don't forget to `change owner and ACL`. 

